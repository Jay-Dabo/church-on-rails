<% content_for :menu, :church %>
<%= render 'title' %>

<div class="container">
  <% can_view_stats = can?(:read, Person) || can?(:read, Team) || can?(:read, Event) || can?(:read, ChurchProcess) %>

  <% if current_church.full_address.present? %>
    <div class="row">
      <div class="col-md-6 col-lg-8">
        <div class="list-group mb-2">
          <%= render 'shared/list_group_header', title: 'Map' %>

          <% if current_church.lat && current_church.lng %>
            <%= map_for current_church, height: '300px' %>
          <% end %>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="list-group mb-2">
          <%= render 'shared/list_group_header', title: 'Address', button: { href: edit_account_church_path, icon: 'pencil', title: 'Edit', can: [:update, current_church] } %>

          <%= icon_container 'map-marker', class: "list-group-item size-xs-small size-sm-normal" do %>
            <%= [current_church.address1, current_church.address2, current_church.postcode, current_church.country].select(&:present?).map{|address| h(address)}.join('<br/>').html_safe %>
          <% end %>

          <%= icon_container :phone, class: "list-group-item size-xs-small size-sm-normal" do %>
            <%= link_to current_church.phone, "tel:#{current_church.phone}", class: 'dotted' %>
          <% end if current_church.phone.present? %>

          <%= icon_container :email, class: "list-group-item size-xs-small size-sm-normal" do %>
            <%= link_to current_church.email, "mailto:#{current_church.email}", class: 'dotted' %>
          <% end if current_church.email.present? %>

        </div>
      </div>
    </div>
  <% else %>
    <div class="list-group mb-2">
      <%= render 'shared/list_group_header', title: 'Address', button: { href: edit_account_church_path, icon: 'pencil', title: 'Edit', can: [:update, current_church] } %>
      <div class="list-group-item list-group-item-padded">
        <% if can? :update, current_church %>
          <h2>No address</h2>
          <p>
            You have not set your church address yet. We highly recommend you <%= link_to "fill it in now", edit_account_church_path %>.
          </p>
        <% else %>
          <h2>No address</h2>
          <p>
            The administrator has not set your church address yet. We apologise for this embarrassing inconvenience.
          </p>
          <p>
            <%= link_to "View your account page", account_person_path %>
          </p>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if can_view_stats %>
    <div class="row">
      <div class="col-md-12 col-lg-6">
        <div class="list-group mb-2">
          <%= render 'chart_header', title: 'Joined members' %>
          <div class="list-group-item">
            <%= line_chart Action.of_type(:joined).where('created_at > ?', 12.months.ago ).group_by_month %>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-3">
        <div class="list-group mb-2">
          <%= render 'chart_header', title: 'Age distribution' %>
          <div class="list-group-item">
            <%= bar_chart by_age_range all_people %>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-3">
        <div class="list-group mb-2">
          <%= render 'chart_header', title: 'Gender distribution' %>
          <div class="list-group-item">
            <%= pie_chart by_gender all_people %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
