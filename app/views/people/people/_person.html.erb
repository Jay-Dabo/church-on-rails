<%= flash_messages container: 'container-sm' %>
<% two_columns = can?(:manage, person) || has_comments_area?(person) %>

<div class="<%= 'container-sm' unless two_columns %>">
  <div class="row">
    <div class="col-xs-12 <%= 'col-lg-7' if two_columns %>">
      <div class="list-group mb-2">
        <%= render 'shared/list_group_header', title: 'Details', button: { icon: :pencil, title: 'Edit', can: [:update, person], href: edit_person_path(person) } %>

        <%= list_group_fields class: 'mb-2', fields: {
            :full_name  => person.full_name,
            'DOB'       => person.dob&.strftime('%d %b %Y'),
            :email      => (link_to(person.email, "mailto:#{person.email}", class: 'dotted') if person.email),
            :phone      => person.phone,
            :gender     => gender_icon(person),
            :facebook   => (link_to(icon_for(:facebook) + "fb.com/#{person.facebook}",     "https://fb.com/#{person.facebook}",     target: '_blank', class: 'fa-container') if person.facebook),
            :twitter    => (link_to(icon_for(:twitter) + "twitter.com/#{person.twitter}", "https://twitter.com/#{person.twitter}", target: '_blank', class: 'fa-container') if person.twitter)
        } %>

        <% if can?(:manage, User) || person.user.present? %>
          <%= list_group_field :account do %>

            <% if person.user.present? %>
              <%= fa_container(person.user.email, person.user) %>
            <% elsif can?(:manage, User) %>
              <%= link_to new_person_user_path(person), class: 'btn btn-secondary btn-sm btn-align-middle' do %>
                <%= icon_for User %>
                Add login account
              <% end %>
            <% end %>

          <% end %>
        <% end %>
      </div>

      <% if person.families.blank? %>
        <% if can? :create, FamilyMembership %>
          <div class="list-group mb-2">
            <%= render 'shared/list_group_header', title: 'Family', button: { icon: Family, title: 'Join', href: person_families_path(person) } %>
          </div>
        <% end %>
      <% else %>
        <% person.families.each do |family| %>
          <%= render 'people/families/family_list_group', family: family %>
        <% end %>
      <% end %>

      <% if can? :read, Team %>
        <div class="list-group mb-2">
          <%= render 'shared/list_group_header', title: 'Teams', button: { icon: Team, title: 'Join', href: person_teams_path(person), can: [:create, TeamMembership] } %>
          <%= render 'people/people/memberships', person: person %>
        </div>
      <% end %>

      <% if can? :read, PersonProcess %>
        <div class="list-group mb-2">
          <%= render 'shared/list_group_header', title: 'Processes', button: { icon: PersonProcess, title: 'Start', href: new_person_person_process_path(person), can: [:create, PersonProcess] } %>
          <%= render partial: 'processes/person_processes/person_process_item', collection: person.person_processes %>
        </div>
      <% end %>
    </div>

    <div class="col-xs-12 <%= 'col-lg-5' if two_columns %>">
      <% if can?(:manage, person) %>
        <div class="list-group mb-2">
          <%= render 'shared/list_group_header', title: 'Management' %>

          <%= fa_container :lock, class: 'list-group-item' do %>
            <%= link_to 'Change password', person_user_password_path(person) %>
          <% end if person.user.present? %>

          <%= fa_container 'handshake-o', class: 'list-group-item' do %>
            <%= link_to 'Merge with another person', person_merge_path(person) %>
          <% end %>

          <%= fa_container :trash, class: 'list-group-item' do %>
            <%= link_to 'Remove person', confirm_destroy_person_path(person) %>
          <% end unless person == current_person %>
        </div>
      <% end %>

      <%= render 'comments/comments/form', resource: person %>
    </div>
  </div>
</div>
